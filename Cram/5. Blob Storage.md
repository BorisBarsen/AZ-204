# [Blob Storage](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)

|              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Endpoint:    | `https://<storage-account>.blob.core.windows/<container>/<blob>.net`                                                                                                                                                                                                                                                                                                                                                                                                          |
| Requires     | [Storage Account](./4.%20Storage%20Account.md)                                                                                                                                                                                                                                                                                                                                                                                                                                |
| Provisioning | [az storage container create](https://learn.microsoft.com/en-us/cli/azure/storage/container?view=azure-cli-latest#az-storage-container-create) <br> [New-AzStorageContainer](https://learn.microsoft.com/en-us/powershell/module/az.storage/new-azstoragecontainer) <br> [az storage blob](https://learn.microsoft.com/en-us/cli/azure/storage/blob) <br> [Set-AzStorageBlobContent](https://learn.microsoft.com/en-us/powershell/module/az.storage/set-azstorageblobcontent) |

![Diagram showing the relationship between a storage account, containers, and blobs](https://learn.microsoft.com/en-us/azure/storage/blobs/media/storage-blobs-introduction/blob1.png)

Authentication:

```sh
az storage <blob/container> <command>
    # Account Key
    --account-key

    # AD Login
    --auth-mode login

    # Connection string
    --connection-string

    # SAS token
    --sas-token
```

## Containers

```sh
az storage container create
    --name # Valid DNS name (3-63)
    [--resource-group]
    [--default-encryption-scope]
    [--fail-on-exist]
    [--metadata]
    [--prevent-encryption-scope-override {false, true}]
    [--public-access {blob, container, off}]
```

## Blobs

Selecting blob:

```sh
az storage blob <command>
    [--blob-endpoint] # https://<storage-account>.blob.core.windows.net
    [--account-name] # When using storage account key or a SAS token
    --container-name
    --name # Case sensitive, cannot end with dot (.) or dash (-)

    # By URL
    --blob-url "https://<storage-account>.blob.core.windows.net/<container>/<blob>?<SAS>" # Omit SAS if you are using another method of authentication.

    [--tags] # Note: Each version of the blob has a unique tag, called an `ETag` that allows to only change a specific instance of the blob.
```

Tiers:

```sh
az storage blob set-tier
    --tier {Archive, Cool, Hot}
    # - Archive tier (offline) - Rarely accessed, üêå ("flexible" latency). Minimum for 180 days.
    #   ‚ùå *ZRS redundancy.
    #   To access data, either rehydrate (copy to different non-archive account in same region) or change tier.
    # To avoid penalty, choose tier with <= days than intended keeping period
    # Does not change last modified property (a policy checking for that may mistakingly override tier)

    [--rehydrate-priority {Standard, High}] # For objects < 10GB
    # - Standard: 15 hours
    # - High: 1 hour
    # Can be checked by `x-ms-rehydrate-priority` header.

    [--type {block, page}] # append is considered always "hot"
```

Conditional operations:

```sh
az storage blob <operation>
    # ETag value, or the wildcard character (*)
    [--if-match]
    [--if-none-match]

    [--if-modified-since]
    [--if-unmodified-since]

    # SQL clause to check tags
    [--tags-condition]
```

Upload:

```sh
az storage blob upload
    # Authenticate

    # Select blob

    # Upload file
    --file "/path/to/file"

    # Upload data
    --data "some data" # or echo "some data" | az storage blob upload --data @-
    [--length] # When reading from stream

    [--encryption-scope]

    [--lease-id]

    [--metadata]

    [--type {append, block, page}]
```

Leasing (temporarily lock blob for everyone without valid lease id):

```sh
leaseId=$(az storage blob lease acquire --lease-duration 60 --output tsv ...)
# az storage blob lease renew --lease-id $leaseId ...
# az storage blob lease change --lease-id $leaseId --proposed-lease-id $newLeaseId ...
# az storage blob lease release --lease-id $leaseId ...
# az storage blob lease break ...
```

Encryption scope (manage encryption at blob or container level):

```sh
az storage account encryption-scope create
    --account-name
    --name "<scope-name>"
    [--key-source {Microsoft.KeyVault, Microsoft.Storage}] # Same rules like encryption at account level
    [--key-uri] # For KeyVault
    [--require-infrastructure-encryption {false, true}] # Inherited from storage account level, if set

az storage container create
    --default-encryption-scope "<scope-name>"
    --prevent-encryption-scope-override true # force all blobs in a container to use the container's default scope

az storage <type> <operation>
    --encryption-scope "<scope-name>"
    # EncryptionScope property for BlobOptions in C#
```
