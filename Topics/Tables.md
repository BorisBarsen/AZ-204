# Tables

| Name                                  | Example                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Notes                                                                                                                                                                                                                                                                                                                                 | Sections                    |
| ------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------- |
| Check HTTP header                     | `<check-header name="header name" failed-check-httpcode="code" failed-check-error-message="message" ignore-case="true \| false">`<br>&nbsp;&nbsp;`<value>Value1</value>`<br>&nbsp;&nbsp;`<value>Value2</value>`<br>`</check-header>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | When multiple value elements are specified, the check is considered a success if any one of the values is a match.                                                                                                                                                                                                                    | inbound                     |
| Get authorization context             | `<get-authorization-context`<br>&nbsp;&nbsp;`provider-id="authorization provider id"`<br>&nbsp;&nbsp;`authorization-id="authorization id"`<br>&nbsp;&nbsp;`context-variable-name="variable name"`<br>&nbsp;&nbsp;`identity-type="managed \| jwt"`<br>&nbsp;&nbsp;`identity="JWT bearer token"`<br>&nbsp;&nbsp;`ignore-error="true \| false" />`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `context-variable-name` is the name of the context variable to receive the Authorization object (`{accessToken: string, claims: Record<string, object>}`). Configure `identity-type=jwt` when the access policy for the authorization is assigned to a service principal. Only `/.default` app-only scopes are supported for the JWT. | inbound                     |
| Restrict caller IPs                   | `<ip-filter action="allow \| forbid">`<br>&nbsp;&nbsp;`<address>address</address>`<br>&nbsp;&nbsp;`<address-range from="address" to="address" />`<br>`</ip-filter>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | At least one `address` or `address-range` element is required.                                                                                                                                                                                                                                                                        | inbound                     |
| Validate Azure Active Directory token | `Simple token validation: <validate-azure-ad-token tenant-id="{{aad-tenant-id}}">`<br>&nbsp;&nbsp;`<client-application-ids>`<br>&nbsp;&nbsp;&nbsp;&nbsp;`<application-id>{{aad-client-application-id}}</application-id>`<br>&nbsp;&nbsp;`</client-application-ids>`<br>`</validate-azure-ad-token>`<br>`Validate that audience and claim are correct: <validate-azure-ad-token tenant-id="{{aad-tenant-id}}" output-token-variable-name="jwt">`<br>&nbsp;&nbsp;`<client-application-ids>`<br>&nbsp;&nbsp;&nbsp;&nbsp;`<application-id>{{aad-client-application-id}}</application-id>`<br>&nbsp;&nbsp;`</client-application-ids>`<br>&nbsp;&nbsp;`<audiences>`<br>&nbsp;&nbsp;&nbsp;&nbsp;`<audience>@(context.Request.OriginalUrl.Host)</audience>`<br>&nbsp;&nbsp;`</audiences>`<br>&nbsp;&nbsp;`<required-claims>`<br>&nbsp;&nbsp;&nbsp;&nbsp;`<claim name="ctry" match="any">`<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`<value>US</value>`<br>&nbsp;&nbsp;&nbsp;&nbsp;`</claim>`<br>&nbsp;&nbsp;`</required-claims>`<br>`</validate-azure-ad-token>`                                                        | To validate a JWT that was provided by another identity provider, use the generic `validate-jwt`. You can secure the whole API with Azure AD authentication by applying the policy on the API level, or you can apply it on the API operation level and use claims for more granular control.                                         | inbound                     |
| Validate client certificate           | `<validate-client-certificate`<br>&nbsp;&nbsp;`validate-revocation="true \| false"`<br>&nbsp;&nbsp;`validate-trust="true \| false"`<br>&nbsp;&nbsp;`validate-not-before="true \| false"`<br>&nbsp;&nbsp;`validate-not-after="true \| false"`<br>&nbsp;&nbsp;`ignore-error="true \| false">`<br>&nbsp;&nbsp;`<identities>`<br>&nbsp;&nbsp;&nbsp;&nbsp;`<identity `<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`thumbprint="certificate thumbprint"`<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`serial-number="certificate serial number"`<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`common-name="certificate common name"`<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`subject="certificate subject string"`<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`dns-name="certificate DNS name"`<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`issuer-subject="certificate issuer"`<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`issuer-thumbprint="certificate issuer thumbprint"`<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`issuer-certificate-id="certificate identifier" />`<br>&nbsp;&nbsp;`</identities>`<br>`</validate-client-certificate>` | `identities` is not required                                                                                                                                                                                                                                                                                                          | inbound                     |
| Control flow                          | `<choose>`<br>&nbsp;&nbsp;`<when condition="Boolean expression \| Boolean constant">`<br>&nbsp;&nbsp;&nbsp;&nbsp;`<!— one or more policy statements to be applied if the above condition is true  -->`<br>&nbsp;&nbsp;`</when>`<br>&nbsp;&nbsp;`<when condition="Boolean expression \| Boolean constant">`<br>&nbsp;&nbsp;&nbsp;&nbsp;`<!— one or more policy statements to be applied if the above condition is true  -->`<br>&nbsp;&nbsp;`</when>`<br>&nbsp;&nbsp;`<otherwise>`<br>&nbsp;&nbsp;&nbsp;&nbsp;`<!— one or more policy statements to be applied if none of the above conditions are true  -->`<br>&nbsp;&nbsp;`</otherwise>`<br>`</choose>`                                                                                                                                                                                                                                                                                                                                                                                                                                                     | The choose policy must contain at least one `<when/>` element. The `<otherwise/>` element is optional.                                                                                                                                                                                                                                | Any                         |
| Emit custom metrics                   | `<emit-metric name="name of custom metric" value="value of custom metric" namespace="metric namespace">`<br>&nbsp;&nbsp;`<dimension name="dimension name" value="dimension value" />`<br>`</emit-metric>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Sends custom metrics in the specified format to Application Insights. You can configure at most 10 custom dimensions for this policy. Counts toward the usage limits for custom metrics per region in a subscription.                                                                                                                 | Any                         |
| Forward request                       | `<forward-request http-version="1 \| 2or1 \| 2" timeout="time in seconds" continue-timeout="time in seconds" follow-redirects="false \| true" buffer-request-body="false \| true" buffer-response="true \| false" fail-on-error-status-code="false \| true"/>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | By default, this policy is set at the global scope.                                                                                                                                                                                                                                                                                   | backend                     |
| Log to event hub                      | `<log-to-eventhub logger-id="id of the logger entity" partition-id="index of the partition where messages are sent" partition-key="value used for partition assignment">`<br>`Expression returning a string to be logged`<br>`</log-to-eventhub>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | The policy is not affected by Application Insights sampling. All invocations of the policy will be logged. Max message size: 200 KB (otherwise truncated).                                                                                                                                                                            | Any                         |
| Mock response                         | `<mock-response status-code="code" content-type="media type"/>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Cancels normal pipeline execution. It prioritizes response content examples, using schemas when available and generating sample responses (or no content is returned). Policy expressions can't be used in attribute values for this policy.                                                                                          | inbound, outbound, on-error |
| Retry                                 | `<retry`<br>&nbsp;&nbsp;`condition="Boolean expression or literal"`<br>&nbsp;&nbsp;`count="number of retry attempts"`<br>&nbsp;&nbsp;`interval="retry interval in seconds"`<br>&nbsp;&nbsp;`max-interval="maximum retry interval in seconds"`<br>&nbsp;&nbsp;`delta="retry interval delta in seconds"`<br>&nbsp;&nbsp;`first-fast-retry="boolean expression or literal">`<br>&nbsp;&nbsp;`<!-- One or more child policies. No restrictions. -->`<br>`</retry>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Executes its child policies once and then retries their execution until the `retry` condition becomes `false` or retry `count` is exhausted. When only the `interval` and `delta` are specified, the wait time between retries increases: `interval + (count - 1)*delta`.                                                             | Any                         |
| Return response                       | `<return-response response-variable-name="existing context variable">`<br>&nbsp;&nbsp;`<set-status>...</set-status>`<br>&nbsp;&nbsp;`<set-header>...</set-header>`<br>&nbsp;&nbsp;`<set-body>...</set-body>`<br>`</return-response>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | Pipeline cancelation, body removal, custom or default response return to caller. Context variable and policy statements modify response if both provided.                                                                                                                                                                             | Any                         |
| Send request                          | `<send-request mode="new \| copy" response-variable-name="" timeout="60 sec" ignore-error="false \| true">`<br>&nbsp;&nbsp;`<set-url>request URL</set-url>`<br>&nbsp;&nbsp;`<set-method>...</set-method>`<br>&nbsp;&nbsp;`<set-header>...</set-header>`<br>&nbsp;&nbsp;`<set-body>...</set-body>`<br>&nbsp;&nbsp;`<authentication-certificate thumbprint="thumbprint" />`<br>&nbsp;&nbsp;`<proxy>...</proxy>`<br>`</send-request>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | Default timeout: 60sec                                                                                                                                                                                                                                                                                                                | Any                         |
| Set HTTP proxy                        | `<proxy url="http://hostname-or-ip:port" username="username" password="password" />`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | Only HTTP is supported between the gateway and the proxy. Basic and NTLM authentication only. `username` and `password` are not required.                                                                                                                                                                                             | inbound                     |
| Set request method                    | `<set-method>HTTP method</set-method>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Policy expressions are allowed.                                                                                                                                                                                                                                                                                                       | inbound, on-error           |
| Set Status Code                       | `<set-status code="HTTP status code" reason="description"/>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | -                                                                                                                                                                                                                                                                                                                                     | Any                         |
| Set Variable                          | `<set-variable name="variable name" value="Expression \| String literal" />`<br>`<set-variable name="IsMobile" value="@(context.Request.Headers.GetValueOrDefault("User-Agent","").Contains("iPad") \|\| context.Request.Headers.GetValueOrDefault("User-Agent","").Contains("iPhone"))" />`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | If the expression contains a literal it will be converted to a string                                                                                                                                                                                                                                                                 | Any                         |
| Authenticate with Basic               | `<authentication-basic username="username" password="password" />`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | Sets the HTTP Authorization header. Recommended using named values to provide credentials, with secrets protected in a key vault.                                                                                                                                                                                                     | inbound                     |
| Authenticate with managed identity    | `<authentication-managed-identity resource="resource" client-id="clientid of user-assigned identity" output-token-variable-name="token-variable" ignore-error="true\|false"/>`<br>`<authentication-managed-identity resource="AD_application_id" output-token-variable-name="msi-access-token" ignore-error="false" />`<br>`<!--Application (client) ID of your own Azure AD Application-->`<br>`<set-header name="Authorization" exists-action="override">`<br>&nbsp;&nbsp;`<value>@("Bearer " + (string)context.Variables["msi-access-token"])</value>`<br>`</set-header>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | After successfully obtaining the token, the policy will set the value of the token in the Authorization header using the Bearer scheme. Both system-assigned identity and any of the multiple user-assigned identities can be used to request a token.                                                                                | inbound                     |
| Get from cache                        | `<cache-lookup vary-by-developer="true \| false" vary-by-developer-groups="true \| false" caching-type="prefer-external \| external \| internal" downstream-caching-type="none \| private \| public" must-revalidate="true \| false" allow-private-response-caching="@(expression to evaluate)">`<br>&nbsp;&nbsp;`<vary-by-header>Accept</vary-by-header>`<br>&nbsp;&nbsp;`<vary-by-header>Accept-Charset</vary-by-header>`<br>&nbsp;&nbsp;`<vary-by-header>Authorization</vary-by-header>`<br>&nbsp;&nbsp;`<vary-by-header>header name</vary-by-header>`<br>&nbsp;&nbsp;`<vary-by-query-parameter>parameter name</vary-by-query-parameter>`<br>`</cache-lookup>`                                                                                                                                                                                                                                                                                                                                                                                                                                             | `vary-by-header` Add one or more of these elements to start caching responses per value of specified header, such as `Accept`, `Accept-Charset`, `Accept-Encoding`, `Accept-Language`, `Authorization`, `Expect`, `From`, `Host`, `If-Match`.                                                                                         | inbound                     |
| Get value from cache                  | `<cache-lookup-value key="cache key value" default-value="value to use if cache lookup resulted in a miss" variable-name="name of a variable looked up value is assigned to" caching-type="prefer-external \| external \| internal" />`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `caching-type`: `internal` to use the built-in API Management cache, `external` to use Redis.                                                                                                                                                                                                                                         | Any                         |
| Store to cache                        | `<cache-store duration="seconds" cache-response="true \| false" />`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | Use with `cache-lookup` in `inbound`                                                                                                                                                                                                                                                                                                  | outbound                    |
| Store value in cache                  | `<cache-store-value key="cache key value" value="value to cache" duration="seconds" caching-type="prefer-external \| external \| internal" />`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | The operation is asynchronous. `caching-type`: `internal` to use the built-in API Management cache, `external` to use Redis.                                                                                                                                                                                                          | Any                         |
| ---                                   | ---                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | ---                                                                                                                                                                                                                                                                                                                                   | ---                         |
| CORS                                  | `<cors allow-credentials="false \| true" terminate-unmatched-request="true \| false">`<br>&nbsp;&nbsp;`<allowed-origins>`<br>&nbsp;&nbsp;&nbsp;&nbsp;`<origin>origin uri</origin>`<br>&nbsp;&nbsp;`</allowed-origins>`<br>&nbsp;&nbsp;`<allowed-methods preflight-result-max-age="number of seconds">`<br>&nbsp;&nbsp;&nbsp;&nbsp;`<method>HTTP verb</method>`<br>&nbsp;&nbsp;`</allowed-methods>`<br>&nbsp;&nbsp;`<allowed-headers>`<br>&nbsp;&nbsp;&nbsp;&nbsp;`<header>header name</header>`<br>&nbsp;&nbsp;`</allowed-headers>`<br>&nbsp;&nbsp;`<expose-headers>`<br>&nbsp;&nbsp;&nbsp;&nbsp;`<header>header name</header>`<br>&nbsp;&nbsp;`</expose-headers>`<br>`</cors>`                                                                                                                                                                                                                                                                                                                                                                                                                               | Configure CORS at multiple scopes. Base element at operation, API, and product. Only cors evaluated on OPTIONS preflight. Other policies on approved request. Policy can be used once.                                                                                                                                                | inbound                     |
| Find and replace string in body       | `<find-and-replace from="what to replace" to="replacement" />`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Policy expressions are allowed.                                                                                                                                                                                                                                                                                                       | Any                         |
| Set backend service                   | `<set-backend-service base-url="base URL of the backend service"  backend-id="name of the backend entity specifying base URL of the backend service" />`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Redirect an incoming request to a different backend than the one specified in the API settings for that operation. Great for `choose`                                                                                                                                                                                                 | inbound, backend            |
| Set body                              | `<set-body template="liquid" xsi-nil="blank \| null">new body value as text</set-body>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `preserveContent` not needed when providing new body. Inbound pipeline: no response yet, so no `preserveContent`. Outbound pipeline: request already sent, so no `preserveContent`. Exception if used in inbound GET with no body.                                                                                                    | inbound, outbound, backend  |
| Set header                            | `<set-header name="header name" exists-action="override \| skip \| append \| delete"><value>value</value></set-header>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | For multiple headers with the same name add additional value elements                                                                                                                                                                                                                                                                 | Any                         |
